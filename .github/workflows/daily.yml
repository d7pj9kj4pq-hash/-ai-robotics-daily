name: AIæ—¥æŠ¥ç”Ÿæˆ

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´9ç‚¹
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        # æ‹‰å–æ‰€æœ‰åˆ†æ”¯å’Œå†å²
        fetch-depth: 0
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests feedparser pyyaml
    
    - name: åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        mkdir -p output/daily output/weekly output/images docs/daily
    
    - name: è¿è¡Œæ–°é—»æ”¶é›†
      run: python scripts/news_collector.py
    
    - name: è¿è¡ŒAIå¤„ç†
      env:
        ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
      run: python scripts/ai_processor.py
    
    - name: ç”ŸæˆæŠ¥å‘Š
      run: python scripts/report_generator.py

    - name: æ¸…ç†æ—§å›¾ç‰‡ï¼ˆå¼ºåˆ¶æ›´æ–°ï¼‰
      run: |
        echo "æ¸…ç†æ—§çš„å›¾ç‰‡ç¼“å­˜..."
        find output/images -name ".updated" -mtime +0 -exec rm -rf {} \; 2>/dev/null || true
        echo "æ¸…ç†å®Œæˆ"
    
    - name: ç”Ÿæˆæ–°å›¾ç‰‡ï¼ˆV2ç‰ˆæœ¬ï¼‰
      run: |
        echo "å¼€å§‹ç”Ÿæˆæ–°å›¾ç‰‡..."
        python scripts/image_generator_v2.py || echo "å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè·³è¿‡"
        echo "å›¾ç‰‡ç”Ÿæˆæ­¥éª¤å®Œæˆ"
    
    - name: éªŒè¯å›¾ç‰‡ç”Ÿæˆ
      run: |
        echo "éªŒè¯ç”Ÿæˆçš„å›¾ç‰‡..."
        today=$(date +%Y-%m-%d)
        if [ -d "output/images/$today" ]; then
          echo "âœ… å›¾ç‰‡ç›®å½•å­˜åœ¨"
          echo "ğŸ“ ç›®å½•å†…å®¹:"
          ls -la "output/images/$today/"
          echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨:"
          find "output/images/$today" -type f
        else
          echo "âŒ å›¾ç‰‡ç›®å½•ä¸å­˜åœ¨"
        fi
    
    - name: ç”Ÿæˆå›¾ç‰‡
      run: python scripts/image_generator.py || echo "å›¾ç‰‡ç”Ÿæˆè·³è¿‡"
    
    - name: æäº¤æ›´æ”¹
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # å…ˆæ‹‰å–æœ€æ–°ä»£ç ï¼Œé¿å…å†²çª
        git fetch origin
        
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
        git add -A
        
        # æäº¤æ›´æ”¹
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: $(date '+%Y-%m-%d') AIæœºå™¨äººæ—¥æŠ¥" || echo "æ— æ–°å˜åŒ–"
        
        # æ¨é€æ›´æ”¹ï¼Œå¦‚æœå¤±è´¥åˆ™å°è¯•å¼ºåˆ¶æ¨é€
        git push origin HEAD:main || git push --force origin HEAD:main
